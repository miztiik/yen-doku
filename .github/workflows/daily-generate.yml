name: Daily Puzzle Generation

on:
  schedule:
    # Run daily at 00:05 UTC
    - cron: '5 0 * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      date:
        description: 'Date to generate puzzles for (YYYY-MM-DD)'
        required: false
        default: ''

env:
  PUZZLE_DIR: docs/puzzles

jobs:
  generate:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            TARGET_DATE="${{ github.event.inputs.date }}"
          else
            TARGET_DATE="$(date -u +%Y-%m-%d)"
          fi
          echo "date=${TARGET_DATE}" >> $GITHUB_OUTPUT
          echo "year=${TARGET_DATE:0:4}" >> $GITHUB_OUTPUT

      - name: Generate puzzles for all difficulties
        run: |
          python scripts/generate.py ${{ steps.date.outputs.date }} --skip-existing --output ${{ env.PUZZLE_DIR }}

      - name: Validate generated puzzles
        run: |
          python -c "
          import json
          import os
          import sys
          sys.path.insert(0, 'scripts')
          from solver import count_solutions
          from validator import is_valid_grid, is_complete, validate_solution
          from difficulty import Difficulty, get_clue_range
          from pathlib import Path

          # Use env var for path - single source of truth
          puzzle_dir = os.environ.get('PUZZLE_DIR', 'docs/puzzles')
          date = '${{ steps.date.outputs.date }}'
          year = '${{ steps.date.outputs.year }}'
          errors = []
          files_found = 0

          for diff in ['easy', 'medium', 'hard', 'extreme']:
              # Convention-based: YYYY-MM-DD-001.json (supports multi-puzzle per day)
              path = Path(f'{puzzle_dir}/{year}/{diff}/{date}-001.json')
              if not path.exists():
                  errors.append(f'{diff}: File not found at {path}')
                  continue
              
              files_found += 1
              puzzle = json.loads(path.read_text())
              
              # Check schema
              required = ['date', 'difficulty', 'clueCount', 'grid', 'solution']
              for field in required:
                  if field not in puzzle:
                      errors.append(f'{diff}: Missing field {field}')
              
              # Check grid validity
              if not is_valid_grid(puzzle['grid']):
                  errors.append(f'{diff}: Invalid grid')
              
              # Check solution completeness
              if not is_complete(puzzle['solution']):
                  errors.append(f'{diff}: Incomplete solution')
              
              # Check solution validity
              if not validate_solution(puzzle['grid'], puzzle['solution']):
                  errors.append(f'{diff}: Solution does not match grid')
              
              # CRITICAL: Check unique solution
              solutions = count_solutions(puzzle['grid'], max_count=2)
              if solutions != 1:
                  errors.append(f'{diff}: Puzzle has {solutions} solutions, must be exactly 1')
              
              # Check clue count in range
              min_c, max_c = get_clue_range(Difficulty(diff))
              if not (min_c <= puzzle['clueCount'] <= max_c):
                  errors.append(f'{diff}: clueCount {puzzle[\"clueCount\"]} not in range [{min_c}, {max_c}]')
              
              print(f'âœ… {diff}: Valid ({puzzle[\"clueCount\"]} clues, unique solution)')

          if errors:
              print('\\nâŒ VALIDATION ERRORS:')
              for e in errors:
                  print(f'  - {e}')
              sys.exit(1)
          
          # Fail-fast: ensure we found all 4 difficulties
          if files_found != 4:
              print(f'\\nâŒ FATAL: Expected 4 puzzle files, found {files_found}')
              sys.exit(1)
          
          print(f'\\nâœ… All {files_found} puzzles validated successfully')
          "

      - name: Verify files exist before commit
        id: verify
        run: |
          EXPECTED=4
          FOUND=0
          YEAR="${{ steps.date.outputs.year }}"
          DATE="${{ steps.date.outputs.date }}"
          
          for diff in easy medium hard extreme; do
            # Convention-based: YYYY-MM-DD-001.json (supports multi-puzzle per day)
            FILE="${{ env.PUZZLE_DIR }}/${YEAR}/${diff}/${DATE}-001.json"
            if [ -f "$FILE" ]; then
              echo "âœ“ Found: $FILE"
              FOUND=$((FOUND + 1))
            else
              echo "âœ— Missing: $FILE"
            fi
          done
          
          echo "found=${FOUND}" >> $GITHUB_OUTPUT
          
          if [ "$FOUND" -ne "$EXPECTED" ]; then
            echo "::error::Expected $EXPECTED puzzle files, found $FOUND"
            exit 1
          fi
          
          echo "âœ… All $FOUND puzzle files verified"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Use env var - single source of truth
          git add ${{ env.PUZZLE_DIR }}/
          
          # Verify something was staged (fail-fast)
          if git diff --staged --quiet; then
            echo "::warning::No changes staged after git add"
            echo "Checking file status..."
            git status --short ${{ env.PUZZLE_DIR }}/
            
            # For scheduled runs, this might mean puzzle already exists (--skip-existing)
            # For manual runs with specific date, this is unexpected
            if [ -n "${{ github.event.inputs.date }}" ]; then
              echo "::error::Manual run for ${{ steps.date.outputs.date }} but no files staged"
              exit 1
            fi
            echo "Puzzle for today may already exist (skipped). Exiting gracefully."
            exit 0
          fi
          
          git commit -m "ðŸ§© Add puzzles for ${{ steps.date.outputs.date }}"
          git push
          echo "âœ… Committed and pushed puzzles for ${{ steps.date.outputs.date }}"
          # Note: Deploy workflow is triggered automatically via workflow_run event
